---
title: "RSpatial-Mask"
author: "Chuliang Xiao"
date: "February 23, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
The script shows a R example of geospatial masking in the Maumee River basin, plotting precipitation of a gridded Lambert netCDF file with a watershed in polygon shapefile on Google Map.

### Library
```{r  warning = FALSE, message = FALSE}
xlib  <- c("tidyverse","ncdf4","raster", "ggmap", "rgdal", "rgeos")
lib   <- lapply(xlib, library, character.only = TRUE) # load the required packages
```
### Read gridded NetCDF file
```{r}
geoFile <- "geo_em.d02.nc"
fname   <- paste0("Precip/", "201401010000.PRECIP_FORCING.nc")
fnc     <- nc_open(fname)
```

### Get Coordinate 
```{r}
lon <- ncvar_get(fnc, varid = "lon")
lat <- ncvar_get(fnc, varid = "lat")
# get varaible precipitation rate
PR  <- ncvar_get(fnc, varid = "precip_rate")
```
### Get Projection
```{r warning = FALSE, message = FALSE}
library(rwrfhydro)
proj4 <- GetProj(geoFile) 
```
### Assign coordinates
```{r}
spPR              <- data.frame(lon = as.vector(lon), lat = as.vector(lat), conc = as.vector(PR))
coordinates(spPR) <- ~ lon+lat
proj4string(spPR) = CRS(proj4)
```

### Rasterization
```{r}
r             <- raster(ncols = ncol(lat),nrows = nrow(lat))
extent(r)     <- extent(spPR)
rPR           <- rasterize(coordinates(spPR), r, spPR$conc)
```
### Read Maumee River Shapfile
```{r}
rMaumee       <- readOGR(dsn = "MaumeeRiverShapefile", layer = "Maumee_Output")
rMaumee.proj  <- spTransform(rMaumee, CRSobj = CRS(proj4string(rPR)))
```

### Plot raster layers and add Maumee polygon
```{r}
#par(mar = c(0.1, 0.1, 0.1, 0.1 ))
plot(rPR*1e4, asp = 1)
plot(rMaumee.proj, add = T)
```
### Raster to Polygon
```{r}
r   <- projectRaster(rPR, crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
rtp <- rasterToPolygons(r)
```
### Google Basemap
```{r warning = FALSE}
bm <- ggmap(get_map(location = bbox(rtp)))
bm +  geom_polygon(data = rtp, 
                   aes(x = long, y = lat, group = group, 
                       fill = rep(rtp$layer*1e4, each = 5)), 
                   size = 0, 
                   alpha = 0.5)  + 
  scale_fill_gradientn(expression("PR\n"~10^{-4}), 
                       colors = topo.colors(255)) 
```

